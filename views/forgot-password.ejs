<%- contentFor('body') %>

<div class="row justify-content-center">
    <div class="col-md-5">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-key"></i> Quên mật khẩu</h4>
            </div>
            <div class="card-body">
                <!-- Hiển thị lỗi từ server -->
                <div id="serverErrors" class="alert alert-danger d-none mb-3">
                    <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i> Lỗi</h6>
                    <hr>
                    <ul id="errorList" class="mb-0 ps-3"></ul>
                </div>
                
                <div class="text-center mb-4">
                    <i class="fas fa-lock fa-3x text-primary mb-3"></i>
                    <p>Nhập địa chỉ email của bạn và chúng tôi sẽ gửi hướng dẫn để đặt lại mật khẩu.</p>
                </div>
                
                <form id="forgotPasswordForm" action="/api/auth/forgot-password" method="post" novalidate>
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    
                    <!-- Email -->
                    <div class="mb-3">
                        <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="email" name="email" required>
                        <div class="invalid-feedback"></div>
                    </div>

                    <!-- Nút gửi -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="submitButton">
                            <i class="fas fa-paper-plane"></i> Gửi yêu cầu
                        </button>
                    </div>
                </form>
            </div>
            <div class="card-footer text-center">
                <p class="mb-0"><a href="/login"><i class="fas fa-arrow-left"></i> Quay lại đăng nhập</a></p>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Khởi tạo validation cho form quên mật khẩu
        $('#forgotPasswordForm').validate({
            // Quy tắc validation
            rules: {
                email: {
                    required: true,
                    email: true
                }
            },
            
            // Thông báo lỗi tùy chỉnh
            messages: {
                email: {
                    required: 'Vui lòng nhập email',
                    email: 'Email không hợp lệ'
                }
            },
            
            // Xử lý khi form hợp lệ
            submitHandler: function(form) {
                // Ẩn thông báo lỗi từ server
                $('#serverErrors').addClass('d-none');
                $('#errorList').empty();
                
                // Lấy dữ liệu form
                const formData = $(form).serializeArray();
                const data = {};
                formData.forEach(item => {
                    data[item.name] = item.value;
                });
                
                // Thay đổi nút gửi thành trạng thái đang xử lý
                const submitButton = $('#submitButton');
                const originalText = submitButton.html();
                submitButton.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...');
                submitButton.prop('disabled', true);
                
                // Gửi request AJAX
                $.ajax({
                    url: '/api/auth/forgot-password',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    headers: {
                        'CSRF-Token': $('input[name="_csrf"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            // Hiển thị thông báo thành công
                            $('#forgotPasswordForm').hide();
                            $('<div class="alert alert-success">')
                                .html('<i class="fas fa-check-circle"></i> Hướng dẫn đặt lại mật khẩu đã được gửi đến email của bạn. Vui lòng kiểm tra hộp thư đến.')
                                .insertBefore('#forgotPasswordForm');
                        } else {
                            handleServerErrors(response);
                            // Khôi phục nút gửi
                            submitButton.html(originalText);
                            submitButton.prop('disabled', false);
                        }
                    },
                    error: function(xhr) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            handleServerErrors(response);
                        } catch (e) {
                            showAlert('danger', 'Đã xảy ra lỗi. Vui lòng thử lại sau.');
                        }
                        // Khôi phục nút gửi
                        submitButton.html(originalText);
                        submitButton.prop('disabled', false);
                    }
                });
                
                return false; // Ngăn form submit mặc định
            }
        });
        
        // Xử lý lỗi từ server
        function handleServerErrors(response) {
            if (response.errors && Array.isArray(response.errors) && response.errors.length > 0) {
                // Xóa các lỗi cũ
                $('#errorList').empty();
                
                // Thêm từng lỗi vào danh sách và hiển thị lỗi trên form
                response.errors.forEach(error => {
                    // Thêm vào danh sách lỗi
                    $('<li>').text(error).appendTo('#errorList');
                    
                    // Hiển thị lỗi trên trường tương ứng
                    if (error.includes('Email')) {
                        $('#email').addClass('is-invalid');
                        $('#email').next('.invalid-feedback').text(error).show();
                    }
                });
                
                // Hiển thị alert box
                $('#serverErrors').removeClass('d-none');
                
                // Hiệu ứng nhấp nháy để thu hút sự chú ý
                $('#serverErrors').css('animation', 'none');
                setTimeout(() => {
                    $('#serverErrors').css('animation', 'shake 0.6s cubic-bezier(.36,.07,.19,.97) both');
                }, 10);
            } else {
                // Nếu không có lỗi cụ thể, hiển thị thông báo chung
                showAlert('danger', response.message || 'Yêu cầu thất bại. Vui lòng thử lại.');
            }
        }
        
        // Hiển thị thông báo
        function showAlert(type, message) {
            const alertContainer = $('#alertContainer');
            const alert = $('<div>')
                .addClass(`alert alert-${type} alert-dismissible fade show`)
                .html(`
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `);
            
            alertContainer.append(alert);
            
            // Tự động ẩn sau 5 giây
            setTimeout(() => {
                alert.removeClass('show');
                setTimeout(() => alert.remove(), 150);
            }, 5000);
        }
    });
</script>
